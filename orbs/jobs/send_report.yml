description: "Runs codacy-coverage-reporter on a tool"

executor: machine

parameters:
  coverage_version:
    type: string
    default: latest
    description: "Codacy coverage version"
  project_token:
    type: string
    default: $CODACY_PROJECT_TOKEN
    description: "Codacy's project token" 

steps:
  - attach_workspace:
      at: ~/workdir
  - run:
      command: |
        if [ -z ${CODACY_PROJECT_TOKEN+x} ]; then
            echo "CODACY_PROJECT_TOKEN not found. Skipping send coverage to Codacy."
        else
          echo "Codacy project token: $CODACY_PROJECT_TOKEN"
          echo "Codacy coverage reporter version: $CODACY_REPORTER_VERSION"
          bash <(curl -Ls https://coverage.codacy.com/get.sh)
        fi
      environment:
        CODACY_REPORTER_VERSION: << parameters.coverage_version >>
        CODACY_PROJECT_TOKEN: << parameters.project_token >>
